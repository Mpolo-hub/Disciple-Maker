<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Statistics - Disciple Maker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    body{font-family:'Inter',sans-serif;background:#f8fafc;color:#334155;overflow-x:hidden;min-height:100vh;display:flex;flex-direction:column}
    header{position:sticky;top:0;left:0;right:0;z-index:1000;background:#fff;box-shadow:0 2px 20px rgba(0,0,0,.1)}
    .nav-container{display:flex;justify-content:space-between;align-items:center;padding:1rem 2rem}
    .nav-links-desktop{display:flex;gap:1.5rem}
    .nav-link{transition:color .3s ease}
    .nav-link:hover{color:#667eea}
    .nav-link.active{font-weight:600;color:#2563eb}
    .hamburger-menu{display:none;flex-direction:column;cursor:pointer;gap:5px}
    .hamburger-menu div{width:25px;height:3px;background:#333;transition:all .3s ease}
    .nav-links-mobile{display:none;flex-direction:column;position:absolute;top:100%;left:0;width:100%;background:#fff;box-shadow:0 2px 10px rgba(0,0,0,.1);padding:1rem 2rem}
    .nav-links-mobile a{padding:.75rem 0;border-bottom:1px solid #eee}
    .nav-links-mobile a:last-child{border-bottom:none}
    @media (max-width:768px){
      .nav-links-desktop,.auth-buttons-desktop{display:none}
      .hamburger-menu{display:flex}
      .nav-container{padding:1rem}
      .nav-links-mobile.open{display:flex}
    }
    footer{background:#012450 !important;margin-top:auto}
    .footer-section{margin-left:10px;margin-right:10px}
    footer .footer-section h3{color:#FF3300 !important}
    footer .footer-section ul li a{color:white !important}
    footer .footer-section ul li a:hover{color:#93c5fd !important}
    .card{background:#fff;border-radius:18px;box-shadow:0 20px 45px -15px rgba(2,6,23,.15);border:1px solid #eef2ff}
    .kpi{display:flex;align-items:center;gap:14px}
    .kpi-icon{width:42px;height:42px;border-radius:12px;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#3b82f6,#6366f1);color:#fff}
    .ring{transform:rotate(-90deg)}
    /* Style modifié pour le badge utilisateur intégré dans la nav */
    .auth-buttons-desktop {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    .ldx-userbadge {
      display: flex;
      align-items: center;
      gap: 10px;
      background: rgba(17,24,39,.86);
      color: #fff;
      padding: 8px 12px;
      border-radius: 999px;
      box-shadow: 0 10px 24px rgba(0,0,0,.18);
    }
    .ldx-userbadge .avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: #334155;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
    }
    .ldx-userbadge .name {
      font-weight: 600;
      font-size: 14px;
      max-width: 220px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .ldx-userbadge .sep {
      opacity: .4;
    }
    .ldx-userbadge .logout {
      background: transparent;
      border: 0;
      color: #cbd5e1;
      cursor: pointer;
      font-size: 12px;
    }
    @media(max-width: 480px) {
      .ldx-userbadge {
        padding: 6px 10px;
      }
      .ldx-userbadge .name {
        max-width: 140px;
      }
    }
    .bar{height:10px;border-radius:999px;background:#e5e7eb;overflow:hidden}
    .bar>span{display:block;height:100%;background:linear-gradient(90deg,#3b82f6,#22c55e)}
    .row-hover:hover{background:#f1f5f9}
    .step{position:relative;padding-left:34px}
    .step::before{content:"";position:absolute;left:12px;top:0;bottom:0;width:2px;background:#e2e8f0}
    .dot{position:absolute;left:6px;top:2px;width:14px;height:14px;border-radius:999px;background:#e2e8f0;border:2px solid #fff;box-shadow:0 0 0 4px #e2e8f0}
    .step.done .dot{background:#22c55e;box-shadow:0 0 0 4px #dcfce7}
    .step.current .dot{background:#3b82f6;box-shadow:0 0 0 4px #dbeafe}
  </style>
</head>

<body class="bg-gray-50">
  <!-- ===== Header ===== -->
  <header>
    <div class="nav-container">
      <div class="text-2xl font-extrabold text-blue-700">Disciple Maker</div>
      <ul class="nav-links-desktop">
        <li><a href="index.html" class="nav-link text-gray-700 hover:text-blue-600 font-medium">Home</a></li>
        <li><a href="discover.html" class="nav-link text-gray-700 hover:text-blue-600 font-medium">Discover Jesus</a></li>
        <li><a href="courses.html" class="nav-link text-gray-700 hover:text-blue-600 font-medium">Training</a></li>
        <li><a href="expert.html" class="nav-link text-gray-700 hover:text-blue-600 font-medium">IT Experts</a></li>
        <li><a href="statistics.html" class="nav-link active text-blue-600 font-medium">Statistics</a></li>
        <li><a href="forum.html" class="nav-link text-gray-700 hover:text-blue-600 font-medium">Forum & AI</a></li>
        <li><a href="contact.html" class="nav-link text-gray-700 hover:text-blue-600 font-medium">Contact</a></li>
        <li><a href="library.html" class="nav-link text-gray-700 hover:text-blue-600 font-medium">Library</a></li>
      </ul>
      <div class="auth-buttons-desktop" style="background:white;">
        <!-- Badge utilisateur intégré directement dans la navigation -->
        <div id="ldxUserBadge" class="ldx-userbadge" style="display:none">
          <div class="avatar" id="ldxAvatar">U</div>
          <span class="name" id="ldxFullName">User</span>
          <span class="sep">·</span>
          <button class="logout" id="ldxLogoutBtn" title="Log out">Logout</button>
        </div>
      </div>
      <div class="hamburger-menu" onClick="toggleMobileMenu()">
        <div class="bar"></div><div class="bar"></div><div class="bar"></div>
      </div>
    </div>
    <div class="nav-links-mobile">
      <a href="index.html" class="nav-link text-gray-700 hover:text-blue-600 font-medium">Home</a>
      <a href="discover.html" class="nav-link text-gray-700 hover:text-blue-600 font-medium">Discover Jesus</a>
      <a href="courses.html" class="nav-link text-gray-700 font-medium">Training</a>
      <a href="expert.html" class="nav-link text-gray-700 hover:text-blue-600 font-medium">IT Experts</a>
      <a href="statistics.html" class="nav-link text-blue-600 font-medium">Statistics</a>
      <a href="forum.html" class="nav-link text-gray-700 hover:text-blue-600 font-medium">Forum & AI</a>
      <a href="contact.html" class="nav-link text-gray-700 hover:text-blue-600 font-medium">Contact</a>
      <a href="library.html" class="nav-link text-gray-700 hover:text-blue-600 font-medium">Library</a>
      <!-- Version mobile du badge utilisateur -->
      <div id="ldxUserBadgeMobile" class="ldx-userbadge mt-4" style="display:none">
        <div class="avatar" id="ldxAvatarMobile">U</div>
        <span class="name" id="ldxFullNameMobile">User</span>
        <span class="sep">·</span>
        <button class="logout" id="ldxLogoutBtnMobile" title="Log out">Logout</button>
      </div>
    </div>
  </header>

  <!-- ===== Main ===== -->
  <main class="container mx-auto px-4 py-10 flex-1">
    <div class="mb-8">
      <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight text-slate-900">Dashboard — Statistics</h1>
      <p class="text-slate-600 mt-2">Track your progress and the overall dynamics of the platform.</p>
    </div>

    <!-- ==== Section 1: Personal statistics ==== -->
    <section class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-10">
      <!-- Overall progress card (Updated) -->
      <article class="card p-6 lg:col-span-1">
        <div class="flex items-center justify-between">
          <div class="kpi">
            <div class="kpi-icon"><i class="fa-solid fa-gauge-high"></i></div>
            <div>
              <div class="text-sm text-slate-500">Overall progress</div>
              <div class="text-2xl font-bold" id="kpiProgress">--%</div>
            </div>
          </div>
          <svg width="88" height="88" viewBox="0 0 100 100" class="ring">
            <circle cx="50" cy="50" r="42" stroke="#e5e7eb" stroke-width="12" fill="none"/>
            <circle id="ringProgress" cx="50" cy="50" r="42" stroke="#3b82f6" stroke-width="12" fill="none" stroke-linecap="round"
                    stroke-dasharray="0 999"/>
          </svg>
        </div>
        <p class="text-sm text-slate-600 mt-3">Sum of completed lessons / total lessons (all your courses).</p>

        <!-- ⬇️ New: progress by course -->
        <div class="mt-5">
          <div class="text-sm font-semibold text-slate-700 mb-3">Progress by course</div>
          <div id="perCourseProgress" class="space-y-3">
            <!-- injected rows -->
          </div>
        </div>
      </article>

      <!-- Certificates card -->
      <article class="card p-6">
        <div class="kpi">
          <div class="kpi-icon"><i class="fa-solid fa-certificate"></i></div>
          <div>
            <div class="text-sm text-slate-500">Certificates obtained</div>
            <div class="text-2xl font-bold"><span id="kpiCerts">--</span> <span class="text-base font-semibold text-slate-500">completed courses</span></div>
          </div>
        </div>
        <ul class="mt-4 space-y-2 text-sm text-slate-700" id="certList"></ul>
      </article>

      <!-- Level + path card -->
      <article class="card p-6">
        <div class="kpi">
          <div class="kpi-icon"><i class="fa-solid fa-stairs"></i></div>
          <div>
            <div class="text-sm text-slate-500">Your level</div>
            <div class="text-2xl font-bold" id="kpiLevel">--</div>
          </div>
        </div>

        <div class="mt-4">
          <div class="text-sm text-slate-500 mb-2">Path: what remains to be completed</div>
          <div class="space-y-4" id="timeline"></div>
        </div>
      </article>
    </section>

    <!-- Focus: "Discovery the meaning of the life" course -->
    <section class="card p-6 mb-10">
      <div class="flex items-center justify-between gap-4 flex-wrap">
        <div>
          <h2 class="text-xl font-bold">Your course: "Discovery the meaning of the life"</h2>
          <p class="text-slate-600 text-sm">Resume where you left off.</p>
        </div>
        <a id="resumeBtn" href="course.html?slug=discovery-the-meaning-of-the-life"
           class="inline-flex items-center gap-2 rounded-full bg-blue-600 hover:bg-blue-700 text-white font-semibold px-5 py-2.5 transition">
          <i class="fa-solid fa-play"></i> Continue
        </a>
      </div>
      <div class="mt-5">
        <div class="text-sm text-slate-500 mb-2">Course progress</div>
        <div class="bar"><span id="courseBar" style="width:0%"></span></div>
        <div class="flex justify-between text-xs text-slate-500 mt-1">
          <span id="coursePct">0%</span><span id="courseSteps">0/0 steps</span>
        </div>
      </div>
    </section>

    <!-- ==== Section 2: General statistics ==== -->
    <section class="card p-6">
      <div class="flex items-center justify-between flex-wrap gap-3">
        <div>
          <h2 class="text-xl font-bold">Most followed courses</h2>
          <p class="text-slate-600 text-sm">Ranked in descending order by enrollments / completions.</p>
        </div>
        <div class="text-sm text-slate-600">
          <span id="platformTotals">-- courses · -- learners</span>
        </div>
      </div>

      <div class="mt-6 divide-y divide-slate-200" id="topCourses"></div>
    </section>
  </main>

  <!-- ===== Footer ===== -->
  <footer class="bg-gray-100 w-full py-12 border-t border-gray-200 mt-12" style="background:#001F3E !important;">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-8">
        <div class="footer-section">
          <h3 class="text-lg font-bold text-gray-800 mb-4">LEARN</h3>
          <ul class="space-y-2">
            <li><a href="#" class="text-gray-600 hover:text-blue-600 transition-colors">Bible Studies</a></li>
            <li><a href="#" class="text-gray-600 hover:text-blue-600 transition-colors">Discipleship Training</a></li>
            <li><a href="#" class="text-gray-600 hover:text-blue-600 transition-colors">Christian Leadership</a></li>
            <li><a href="#" class="text-gray-600 hover:text-blue-600 transition-colors">Mission & Evangelism</a></li>
            <li><a href="#" class="text-gray-600 hover:text-blue-600 transition-colors">Mentorship</a></li>
            <li><a href="#" class="text-gray-600 hover:text-blue-600 transition-colors">Certifications</a></li>
          </ul>
        </div>
        <div class="footer-section">
          <h3 class="text-lg font-bold text-gray-800 mb-4">TRAINING</h3>
          <ul class="space-y-2">
            <li><a href="#" class="text-gray-600 hover:text-blue-600 transition-colors">Bible Courses</a></li>
            <li><a href="#" class="text-gray-600 hover:text-blue-600 transition-colors">Theology Courses</a></li>
            <li><a href="#" class="text-gray-600 hover:text-blue-600 transition-colors">Leadership Courses</a></li>
            <li><a href="#" class="text-gray-600 hover:text-blue-600 transition-colors">Mission Courses</a></li>
            <li><a href="#" class="text-gray-600 hover:text-blue-600 transition-colors">Spirituality Courses</a></li>
            <li><a href="#" class="text-gray-600 hover:text-blue-600 transition-colors">Apologetics Courses</a></li>
          </ul>
        </div>
        <div class="footer-section">
          <h3 class="text-lg font-bold text-gray-800 mb-4">CERTIFICATION</h3>
          <ul class="space-y-2">
            <li><a href="#" class="text-gray-600 hover:text-blue-600 transition-colors">Certifications</a></li>
            <li><a href="#" class="text-gray-600 hover:text-blue-600 transition-colors">Biblical Diploma</a></li>
            <li><a href="#" class="text-gray-600 hover:text-blue-600 transition-colors">Leadership Certificate</a></li>
            <li><a href="#" class="text-gray-600 hover:text-blue-600 transition-colors">Pastoral Training</a></li>
            <li><a href="#" class="text-gray-600 hover:text-blue-600 transition-colors">Certified Evangelist</a></li>
          </ul>
        </div>
        <div class="footer-section">
          <h3 class="text-lg font-bold text-gray-800 mb-4">RESOURCES</h3>
          <ul class="space-y-2">
            <li><a href="#" class="text-gray-600 hover:text-blue-600 transition-colors">Resource Center</a></li>
            <li><a href="#" class="text-gray-600 hover:text-blue-600 transition-colors">Events</a></li>
            <li><a href="#" class="text-gray-600 hover:text-blue-600 transition-colors">Blog</a></li>
            <li><a href="#" class="text-gray-600 hover:text-blue-600 transition-colors">Tutorials</a></li>
            <li><a href="#" class="text-gray-600 hover:text-blue-600 transition-colors">Documentation</a></li>
            <li><a href="#" class="text-gray-600 hover:text-blue-600 transition-colors">Testimonials</a></li>
          </ul>
        </div>
        <div class="footer-section">
          <h3 class="text-lg font-bold text-gray-800 mb-4">PLANS</h3>
          <ul class="space-y-2">
            <li><a href="#" class="text-gray-600 hover:text-blue-600 transition-colors">Pricing</a></li>
            <li><a href="#" class="text-gray-600 hover:text-blue-600 transition-colors">For Students</a></li>
            <li><a href="#" class="text-gray-600 hover:text-blue-600 transition-colors">For Churches</a></li>
            <li><a href="#" class="text-gray-600 hover:text-blue-600 transition-colors">For Organizations</a></li>
            <li><a href="#" class="text-gray-600 hover:text-blue-600 transition-colors">Free Courses</a></li>
            <li><a href="#" class="text-gray-600 hover:text-blue-600 transition-colors">Scholarships</a></li>
          </ul>
        </div>
        <div class="footer-section">
          <h3 class="text-lg font-bold text-gray-800 mb-4">COMMUNITY</h3>
          <ul class="space-y-2">
            <li><a href="#" class="text-gray-600 hover:text-blue-600 transition-colors">Forum</a></li>
            <li><a href="#" class="text-gray-600 hover:text-blue-600 transition-colors">Discussions</a></li>
            <li><a href="#" class="text-gray-600 hover:text-blue-600 transition-colors">Code of Conduct</a></li>
            <li><a href="#" class="text-gray-600 hover:text-blue-600 transition-colors">FAQ</a></li>
            <li><a href="#" class="text-gray-600 hover:text-blue-600 transition-colors">Discord</a></li>
            <li><a href="#" class="text-gray-600 hover:text-blue-600 transition-colors">Telegram</a></li>
          </ul>
        </div>
      </div>

      <div class="mt-12 pt-8 border-t border-gray-300 flex flex-col md:flex-row justify-between items-center">
        <div class="flex items-center mb-4 md:mb-0">
          <div class="text-2xl font-extrabold text-blue-700 mr-2">Disciple Maker</div>
          <span class="text-gray-500 text-sm">© 2023 All rights reserved.</span>
        </div>
        <div class="flex space-x-6">
          <a href="#" class="text-gray-500 hover:text-blue-600 transition-colors"><i class="fab fa-facebook-f"></i></a>
          <a href="#" class="text-gray-500 hover:text-blue-600 transition-colors"><i class="fab fa-twitter"></i></a>
          <a href="#" class="text-gray-500 hover:text-blue-600 transition-colors"><i class="fab fa-instagram"></i></a>
          <a href="#" class="text-gray-500 hover:text-blue-600 transition-colors"><i class="fab fa-linkedin-in"></i></a>
          <a href="#" class="text-gray-500 hover:text-blue-600 transition-colors"><i class="fab fa-youtube"></i></a>
        </div>
      </div>
    </div>
  </footer>

  <!-- ===== Scripts ===== -->
  <script>
    function toggleMobileMenu(){document.querySelector('.nav-links-mobile').classList.toggle('open')}
  </script>

  <!-- User badge (Firebase) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCwO2PtRkrbmlIs8QOX_71a6NYBR_FhZc8",
      authDomain: "disciple-maker.firebaseapp.com",
      projectId: "disciple-maker",
      storageBucket: "disciple-maker.firebasestorage.app",
      messagingSenderId: "202105691136",
      appId: "1:202105691136:web:9e27bb1d909dd89cba4ce5",
      measurementId: "G-VBCV8SH3S0"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);
    const appId= firebaseConfig.projectId;

    // Éléments du DOM
    const $badgeDesktop = document.getElementById('ldxUserBadge');
    const $nameDesktop = document.getElementById('ldxFullName');
    const $avatarDesktop = document.getElementById('ldxAvatar');
    const $logoutDesktop = document.getElementById('ldxLogoutBtn');
    
    const $badgeMobile = document.getElementById('ldxUserBadgeMobile');
    const $nameMobile = document.getElementById('ldxFullNameMobile');
    const $avatarMobile = document.getElementById('ldxAvatarMobile');
    const $logoutMobile = document.getElementById('ldxLogoutBtnMobile');

    function initials(first, last) {
      const f = (first || '').trim()[0] || '';
      const l = (last || '').trim()[0] || '';
      return (f + l || 'U').toUpperCase();
    }

    async function loadProfile(user) {
      const ref = doc(db, `artifacts/${appId}/users/${user.uid}/profile`, 'details');
      const snap = await getDoc(ref);
      let first = '', last = '';
      
      if (snap.exists()) {
        const d = snap.data(); 
        first = d.firstName || ''; 
        last = d.lastName || '';
      } else if (user.displayName) {
        const parts = user.displayName.split(' '); 
        first = parts[0] || ''; 
        last = parts.slice(1).join(' ');
      } else { 
        first = (user.email || '').split('@')[0]; 
        last = ''; 
      }
      
      const fullName = [first, last].filter(Boolean).join(' ') || 'User';
      const userInitials = initials(first, last);
      
      // Mise à jour desktop
      $nameDesktop.textContent = fullName;
      $avatarDesktop.textContent = userInitials;
      $badgeDesktop.style.display = 'flex';
      
      // Mise à jour mobile
      $nameMobile.textContent = fullName;
      $avatarMobile.textContent = userInitials;
      $badgeMobile.style.display = 'flex';
    }

    function handleLogout() {
      signOut(auth).then(() => {
        window.location.href = 'login.html';
      }).catch((error) => {
        console.error("Erreur lors de la déconnexion:", error);
      });
    }

    // Gestionnaires d'événements
    $logoutDesktop?.addEventListener('click', handleLogout);
    $logoutMobile?.addEventListener('click', handleLogout);

    // Surveillance de l'état d'authentification
    onAuthStateChanged(auth, (user) => { 
      if (user) { 
        loadProfile(user).catch(console.error); 
      } else {
        // Rediriger vers la page de connexion si l'utilisateur n'est pas connecté
        window.location.href = 'login.html';
      } 
    });
  </script>

  <!-- Data & statistics rendering -->
  <script>
    // ============ DATA LAYER (replace with LearnDash/Firestore) ============
    async function fetchUserStats(){
      // overallProgressPct : overall progress %
      // coursesProgress : progress % by course (for bars)
      return {
        overallProgressPct: 64,
        coursesProgress: [
          { title: "Discovery the meaning of the life", pct: 39 },
          { title: "Leadership Essentials",             pct: 72 },
          { title: "Mission & Evangelism",              pct: 18 },
          { title: "Biblical Foundations",              pct: 85 }
        ],
        certificates: [
          { course: "Foundations of Faith", date: "2025-06-12" },
          { course: "Leadership Essentials", date: "2025-07-05" }
        ],
        level: "Intermediate",
        path: [
          { title: "Registration & Discovery", status: "done" },
          { title: "Discovery the meaning of the life", status: "current" },
          { title: "Leadership", status: "todo" },
          { title: "Mission & Evangelism", status: "todo" }
        ],
        focusCourse: {
          title: "Discovery the meaning of the life",
          completedSteps: 7,
          totalSteps: 18
        }
      };
    }

    async function fetchPlatformStats(){
      const courses = [
        { title: "Discovery the meaning of the life", learners: 823, completionRate: 0.54 },
        { title: "Leadership Essentials",              learners: 702, completionRate: 0.61 },
        { title: "Biblical Foundations",               learners: 655, completionRate: 0.48 },
        { title: "Mission & Evangelism",               learners: 519, completionRate: 0.41 },
        { title: "Apologetics 101",                    learners: 412, completionRate: 0.33 },
        { title: "Prayer & Spirituality",              learners: 327, completionRate: 0.52 }
      ];
      const totals = { courseCount: courses.length, learners: courses.reduce((a,c)=>a+c.learners,0) };
      courses.sort((a,b)=>b.learners - a.learners);
      return { courses, totals };
    }

    // ============ RENDER LAYER ============
    function setRingProgress(el, pct){
      const r=42, circ=2*Math.PI*r, dash=Math.round((pct/100)*circ);
      el.setAttribute('stroke-dasharray', `${dash} ${circ-dash}`);
    }

    function renderTimeline(container, steps){
      container.innerHTML = "";
      steps.forEach((s, i)=>{
        const div = document.createElement('div');
        div.className = `step ${s.status} ${i<steps.length-1 ? 'pb-4':''}`;
        div.innerHTML = `
          <span class="dot"></span>
          <div class="font-semibold ${s.status==='done'?'text-green-700':s.status==='current'?'text-blue-700':'text-slate-700'}">${s.title}</div>
          <div class="text-xs text-slate-500">${s.status==='done'?'Completed':s.status==='current'?'In progress':'To do'}</div>
        `;
        container.appendChild(div);
      });
    }

    function colorForIndex(i){
      const palettes = [
        "linear-gradient(90deg,#3b82f6,#6366f1)",
        "linear-gradient(90deg,#22c55e,#84cc16)",
        "linear-gradient(90deg,#f59e0b,#ef4444)",
        "linear-gradient(90deg,#06b6d4,#3b82f6)",
        "linear-gradient(90deg,#a855f7,#ec4899)",
        "linear-gradient(90deg,#14b8a6,#84cc16)",
      ];
      return palettes[i % palettes.length];
    }

    function renderTopCourses(container, courses){
      container.innerHTML = "";
      courses.forEach((c, i)=>{
        const row = document.createElement('div');
        row.className = "row-hover flex items-center justify-between py-4 px-2";
        const pct = Math.round(c.completionRate*100);
        row.innerHTML = `
          <div class="min-w-0 flex-1">
            <div class="flex items-center gap-3">
              <div class="w-6 h-6 rounded-md flex items-center justify-center text-white text-xs font-bold" style="background:#2563eb">${i+1}</div>
              <div class="truncate">
                <div class="font-semibold text-slate-900 truncate">${c.title}</div>
                <div class="text-xs text-slate-500">${c.learners.toLocaleString()} learners · ${pct}% completions</div>
              </div>
            </div>
          </div>
          <div class="w-56 ml-6">
            <div class="bar"><span style="width:${Math.min(100, (c.learners / courses[0].learners)*100)}%; background:${colorForIndex(i)}"></span></div>
          </div>
        `;
        container.appendChild(row);
      });
    }

    // ⬇️ New: render progress by course (in KPI card)
    function renderPerCourseProgress(container, items){
      container.innerHTML = "";
      items.forEach((it, i)=>{
        const row = document.createElement('div');
        row.className = "flex items-center gap-3";
        row.innerHTML = `
          <div class="min-w-0 flex-1">
            <div class="flex items-center justify-between">
              <div class="truncate text-sm font-medium text-slate-800" title="${it.title}">${it.title}</div>
              <div class="text-xs text-slate-500 ml-3">${it.pct}%</div>
            </div>
            <div class="bar mt-1"><span style="width:${it.pct}%; background:${colorForIndex(i)}"></span></div>
          </div>
        `;
        container.appendChild(row);
      });
    }

    (async function init(){
      // USER
      const user = await fetchUserStats();
      document.getElementById('kpiProgress').textContent = user.overallProgressPct+"%";
      setRingProgress(document.getElementById('ringProgress'), user.overallProgressPct);

      // ⬇️ Render course bars
      renderPerCourseProgress(document.getElementById('perCourseProgress'), user.coursesProgress || []);

      document.getElementById('kpiCerts').textContent = user.certificates.length;
      const certUL = document.getElementById('certList');
      certUL.innerHTML = user.certificates.map(c=>`<li class="flex items-center gap-2"><i class="fa-solid fa-check-circle text-green-600"></i> <span><span class="font-medium">${c.course}</span> — ${c.date}</span></li>`).join("");

      document.getElementById('kpiLevel').textContent = user.level;
      renderTimeline(document.getElementById('timeline'), user.path);

      const pct = Math.round((user.focusCourse.completedSteps / user.focusCourse.totalSteps)*100);
      document.getElementById('courseBar').style.width = pct+"%";
      document.getElementById('coursePct').textContent = pct+"%";
      document.getElementById('courseSteps').textContent = `${user.focusCourse.completedSteps}/${user.focusCourse.totalSteps} steps`;

      // PLATFORM
      const platform = await fetchPlatformStats();
      document.getElementById('platformTotals').textContent = `${platform.totals.courseCount} courses · ${platform.totals.learners.toLocaleString()} learners`;
      renderTopCourses(document.getElementById('topCourses'), platform.courses);
    })();
  </script>
</body>
</html>